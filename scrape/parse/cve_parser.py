import os.path
import json
from django.conf import settings
from cve_data.models import *

ROOT = settings.BASE_DIR + '/../static'

class CveParser:
    
    def __init__(self, file_path):
    	self.__file_path = ROOT + file_path
    	self.__file_exists = os.path.isfile(self.__file_path)

    @property
    def file_path(self):
    	return self.__file_path

    @file_path.setter
    def file_path(self, file_path):
    	self.__file_path = ROOT + file_path
    	self.__file_exists = os.path.isfile(self.__file_path)

    @property
    def file_exists(self):
    	return self.__file_exists

    def __formatDate(self, dateString):
        return '2017-01-01'#TODO

    def __getMetricObjectByName(self, metric_name):
        metric = MetricType.objects.filter(name=metric_name).first()

        #Create the metric object if it does not exist
        if metric is None:
            metric = MetricType()
            metric.name = metric_name
            metric.description = metric_name #placeholder for the time being
            metric.save()

        return metric

    def __createCveScoreObjects(self, cve, metric, scoreData):
        exploitability = ScoreType.objects.filter(name='exploitabilityScore').first()
        impact = ScoreType.objects.filter(name='impactScore').first()

        # Create exploitability score if the object does not exist
        if exploitability is None:
            exploitability = ScoreType()
            exploitability.name = 'exploitabilityScore'
            exploitability.description = 'exploitabilityScore' #placeholder for the time being
            exploitability.save()

        # Create impact score if the object does not exist
        if impact is None:
            impact = ScoreType()
            impact.name = 'impactScore'
            impact.description = 'impactScore' #placeholder for the time being
            impact.save()

        # Create Exploitability CveScore Object
        exploitabilityScore = CVEScore()
        exploitabilityScore.cve = cve
        exploitabilityScore.score_type = exploitability
        exploitabilityScore.metric_type = metric
        exploitabilityScore.value = scoreData['exploitabilityScore']
        if 'severity' in scoreData:
            exploitabilityScore.severity = scoreData['severity']
        else:
            exploitabilityScore.severity = 'NONE'

        # Create Impact CveScore Object
        impactScore = CVEScore()
        impactScore.cve = cve
        impactScore.score_type = impact
        impactScore.metric_type = metric
        impactScore.value = scoreData['impactScore']
        if 'severity' in scoreData:
            impactScore.severity = scoreData['severity']
        else:
            impactScore.severity = 'NONE'

        exploitabilityScore.save()
        impactScore.save()

    def __createReferenceObject(self, cve, url):
        reference = ReferenceURL()
        reference.url = url
        reference.cve = cve
        reference.save()

    def parse(self):
        return_data = []
        
    	if self.__file_exists:
            with open(self.__file_path) as data_file:    
                data = json.load(data_file)
                for datum in data:
                    if 'cve' in datum:
                        # First, create the CVE object
                        cve = CVE()
                        cve.cve_id = datum['cve']['CVE_data_meta']['ID']
                        cve.description = datum['cve']['description']['description_data'][0]['value']
                        cve.date = self.__formatDate(datum['publishedDate'])
                        cve.save()

                        if 'impact' in datum:
                            # Create the CVE Score objects
                            for metric_name in datum['impact']:
                                metric = self.__getMetricObjectByName(metric_name)
                                self.__createCveScoreObjects(cve, metric, datum['impact'][metric_name])

                        if 'references' in datum:
                            # Create the reference URL objects
                            for reference in datum['references']:
                                self.__createReferenceObject(cve, reference['url'])

                        return_data.append(cve)
            return return_data
        else:
            return None
